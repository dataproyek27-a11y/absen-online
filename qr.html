<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Generator Banyak Nama</title>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    body{font-family:Arial;background:#f4f6f9;margin:0;padding:0}
    .box{max-width:1000px;margin:16px auto;background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h2{margin:0 0 6px}
    .mini{font-size:12px;color:#666;margin-bottom:10px}
    textarea,input,button{width:100%;padding:12px;margin:6px 0;border-radius:10px;border:1px solid #ddd}
    textarea{min-height:150px;resize:vertical}
    button{background:#2563eb;color:white;border:none;font-weight:bold;cursor:pointer}
    button:hover{opacity:.92}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > div{flex:1;min-width:220px}
    .green{background:#16a34a}
    .gray{background:#64748b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));gap:12px;margin-top:10px}
    .card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:12px}
    .qrbox{display:flex;justify-content:center;align-items:center;padding:6px;border-radius:12px;background:#f8fafc;border:1px solid #eef2f7}
    .name{font-weight:bold;margin:6px 0 0}
    .bag{margin:2px 0;color:#444;font-size:13px}
    .data{margin:6px 0 0;color:#666;font-size:11px;word-break:break-word}
    a.back{display:inline-block;margin:8px 0;text-decoration:none;color:#2563eb;font-weight:bold}
  </style>
</head>
<body>
<div class="box">
  <a class="back" href="index.html">‚¨Ö Kembali ke Menu</a>

  <h2>üéØ QR Generator Banyak Nama</h2>
  <div class="mini">Format per baris: <b>Nama|Bagian</b> contoh: <b>Andi|Proyek A</b></div>

  <div class="row">
    <div>
      <label>Bagian default (opsional)</label>
      <input id="defaultBagian" placeholder="Proyek A / Kelas 9A"/>
    </div>
    <div>
      <label>Ukuran QR</label>
      <input id="size" type="number" value="160" min="100" max="300"/>
    </div>
  </div>

  <textarea id="list" placeholder="Contoh:
Andi|Proyek A
Budi|Proyek A
Siti|Proyek A"></textarea>

  <div class="row">
    <div><button onclick="generate()">üéØ Buat Semua QR</button></div>
    <div><button class="green" onclick="downloadZIP()">‚¨áÔ∏è Download ZIP</button></div>
    <div><button class="gray" onclick="printAll()">üñ®Ô∏è Print Massal</button></div>
  </div>

  <div class="mini" id="info">Belum ada QR dibuat.</div>
  <div class="grid" id="grid"></div>
</div>

<script>
  let qrItems = [];

  function parseLines(){
    const txt = document.getElementById("list").value.trim();
    const defaultBagian = document.getElementById("defaultBagian").value.trim();
    const lines = txt.split("\\n").map(x => x.trim()).filter(Boolean);

    const items = [];
    for(const line of lines){
      if(line.includes("|")){
        const parts = line.split("|");
        const nama = parts[0].trim();
        const bagian = parts.slice(1).join("|").trim();
        if(nama && bagian) items.push({nama, bagian});
      }else{
        if(defaultBagian) items.push({nama: line.trim(), bagian: defaultBagian});
      }
    }
    return items;
  }

  function safeFileName(str){
    return str.replace(/[\\\\/:*?"<>|]/g, "-").replace(/\\s+/g, " ").trim();
  }

  function generate(){
    const size = parseInt(document.getElementById("size").value || "160");
    const items = parseLines();
    if(items.length === 0) return alert("List kosong / format salah!");

    qrItems = items.map(x => ({...x, data: x.nama + "|" + x.bagian, png:null}));

    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    qrItems.forEach((x, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      const qrDiv = document.createElement("div");
      qrDiv.className = "qrbox";
      const holder = document.createElement("div");
      qrDiv.appendChild(holder);

      card.appendChild(qrDiv);

      const n = document.createElement("div"); n.className="name"; n.innerText=x.nama;
      const b = document.createElement("div"); b.className="bag"; b.innerText=x.bagian;
      const d = document.createElement("div"); d.className="data"; d.innerText=x.data;

      card.appendChild(n); card.appendChild(b); card.appendChild(d);
      grid.appendChild(card);

      new QRCode(holder, { text:x.data, width:size, height:size });

      setTimeout(() => {
        const img = holder.querySelector("img");
        if(img) qrItems[idx].png = img.src;
      }, 250);
    });

    document.getElementById("info").innerText = "‚úÖ Berhasil buat " + qrItems.length + " QR";
  }

  async function downloadZIP(){
    if(qrItems.length === 0) return alert("Klik Buat Semua QR dulu!");
    const zip = new JSZip();
    const folder = zip.folder("QR-Absen");

    for(const item of qrItems){
      if(!item.png) return alert("Tunggu sebentar, QR belum siap semua.");
      const base64 = item.png.split(",")[1];
      folder.file(safeFileName(item.nama+" - "+item.bagian+".png"), base64, {base64:true});
    }

    const blob = await zip.generateAsync({type:"blob"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "QR-Absen.zip";
    a.click();
    URL.revokeObjectURL(url);
  }

  function printAll(){
    if(qrItems.length === 0) return alert("Klik Buat Semua QR dulu!");
    const size = parseInt(document.getElementById("size").value || "160");

    let html = "<html><head><title>Print QR</title><style>"+
      "body{font-family:Arial;margin:10px}"+
      ".grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}"+
      ".card{border:1px solid #ddd;border-radius:12px;padding:10px}"+
      ".qr{display:flex;justify-content:center;padding:6px}"+
      ".name{font-weight:bold;margin-top:6px}"+
      ".bag{font-size:12px;color:#444}"+
      "img{width:"+size+"px;height:"+size+"px}"+
      "</style></head><body><div class='grid'>";

    qrItems.forEach(x => {
      html += "<div class='card'><div class='qr'>"+(x.png?("<img src='"+x.png+"'/>"):"")+
              "</div><div class='name'>"+x.nama+"</div><div class='bag'>"+x.bagian+"</div></div>";
    });

    html += "</div></body></html>";

    const w = window.open("", "", "width=1000,height=700");
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
    w.close();
  }
</script>
</body>
</html>